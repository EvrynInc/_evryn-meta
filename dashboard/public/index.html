<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <title>Evryn Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 16px;
      line-height: 1.5;
    }
    h1 { color: #fff; margin-bottom: 4px; font-size: 1.4rem; }
    h2 { color: #888; margin: 16px 0 8px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

    /* Agent Grid */
    .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 16px; }
    .agent-card {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 10px 12px;
      border: 1px solid #333;
      position: relative;
    }
    .agent-card.green { border-color: #22c55e; }
    .agent-card.yellow { border-color: #eab308; }
    .agent-card.red { border-color: #ef4444; }
    .agent-card.halted { opacity: 0.6; }
    .agent-name { font-size: 0.8rem; color: #fff; font-weight: 500; }
    .agent-spend { font-size: 1rem; font-weight: 600; margin-top: 2px; }
    .agent-spend.green { color: #22c55e; }
    .agent-spend.yellow { color: #eab308; }
    .agent-spend.red { color: #ef4444; }
    .agent-budget { font-size: 0.7rem; color: #666; }
    .status-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.active { background: #22c55e; }
    .status-dot.halted { background: #ef4444; }
    .status-dot.idle { background: #666; }

    /* Legends */
    .legend { display: flex; gap: 16px; font-size: 0.7rem; color: #666; margin-bottom: 12px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .legend-bar { width: 12px; height: 3px; border-radius: 1px; }

    /* Filters */
    .filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
    .filters-label { font-size: 0.75rem; color: #666; margin-right: 4px; }
    .filter-btn {
      padding: 4px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      color: #888;
      font-size: 0.75rem;
    }
    .filter-btn.active { background: #333; color: #fff; border-color: #555; }
    .filter-btn:hover:not(.active) { background: #222; }

    /* Activity Table */
    .activity-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-bottom: 16px; }
    .activity-table th {
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid #333;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.65rem;
      letter-spacing: 0.5px;
    }
    .activity-table td {
      padding: 6px;
      border-bottom: 1px solid #1a1a1a;
      color: #888;
      vertical-align: top;
    }
    .activity-table tr:hover td { background: #1a1a1a; }
    .activity-table .col-time { width: 110px; white-space: nowrap; color: #666; }
    .activity-table .col-type { width: 50px; }
    .activity-table .col-agent { width: 60px; color: #60a5fa; }
    .activity-table .col-from, .activity-table .col-to { width: 130px; }
    .activity-table .col-model { width: 55px; }
    .activity-table .col-tokens { width: 50px; text-align: right; }
    .activity-table .col-cost { width: 55px; text-align: right; }
    .activity-table .col-subject { min-width: 120px; max-width: 200px; }
    .activity-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.6rem;
      text-transform: uppercase;
    }
    .type-api { background: #1e3a5f; color: #60a5fa; }
    .type-scheduled { background: #1e3a3a; color: #2dd4bf; }
    .type-email-in { background: #14532d; color: #22c55e; }
    .type-email-out { background: #7c2d12; color: #f97316; }
    .type-inter { background: #4a1d6a; color: #a855f7; }

    .load-more {
      display: block;
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
    }
    .load-more:hover { background: #222; color: #fff; }

    /* Month Spend Collapsible */
    .collapsible-header { display: flex; align-items: center; cursor: pointer; gap: 8px; }
    .collapsible-header:hover { opacity: 0.8; }
    .collapse-icon { transition: transform 0.2s; font-size: 0.7rem; color: #666; }
    .collapse-icon.open { transform: rotate(90deg); }
    .month-spend-content { display: none; margin-top: 8px; background: #111; border-radius: 6px; padding: 12px; margin-bottom: 16px; max-width: 280px; }
    .month-spend-content.open { display: block; }
    .month-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem; border-bottom: 1px solid #1a1a1a; }
    .month-row:last-child { border-bottom: none; }
    .month-agent { color: #888; }
    .month-amount { color: #60a5fa; }
    .month-total { margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; font-weight: 600; }

    /* Usage Chart */
    .chart-section { margin-bottom: 16px; }
    .chart-container {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px;
      height: 300px;
      min-height: 150px;
      max-height: 800px;
      resize: vertical;
      overflow: hidden;
      position: relative;
    }
    .chart-controls { display: flex; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; align-items: center; }
    .chart-controls-row { display: flex; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; align-items: center; }
    .chart-controls .separator { color: #333; margin: 0 4px; }
    .chart-agent-btn { min-width: unset; }
    .chart-agent-btn.active { color: #fff; }
    .chart-datetime-input {
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    .chart-datetime-input::-webkit-calendar-picker-indicator { filter: invert(1); }

    /* Range Slider */
    .range-slider-container {
      position: relative;
      height: 32px;
      background: #111;
      border: 1px solid #333;
      border-radius: 4px;
      margin-top: 6px;
      margin-bottom: 12px;
      user-select: none;
      cursor: default;
    }
    .range-slider-track {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }
    .range-slider-selected {
      position: absolute;
      top: 0; bottom: 0;
      background: rgba(96, 165, 250, 0.15);
      border-left: 2px solid #60a5fa;
      border-right: 2px solid #60a5fa;
      cursor: grab;
    }
    .range-slider-selected:active { cursor: grabbing; }
    .range-slider-handle {
      position: absolute;
      top: 0; bottom: 0;
      width: 8px;
      background: #60a5fa;
      border-radius: 2px;
      cursor: ew-resize;
      z-index: 2;
    }
    .range-slider-handle:hover { background: #93c5fd; }
    .range-slider-handle.left { left: -4px; }
    .range-slider-handle.right { right: -4px; }

    /* Misc */
    .truncate { cursor: help; }
    .loading { color: #666; padding: 40px; text-align: center; }
    .error { color: #ef4444; padding: 40px; text-align: center; }
    .refresh { position: fixed; top: 16px; right: 16px; background: #333; border: none; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; z-index: 50; }
    .refresh:hover { background: #444; }
    .timestamp { color: #666; font-size: 0.75rem; margin-bottom: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>
  <!-- Login Overlay -->
  <div id="login-overlay" style="display:none; position:fixed; inset:0; background:#0a0a0a; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:40px; border-radius:8px; border:1px solid #333; text-align:center;">
      <h2 style="color:#fff; margin-bottom:20px;">Evryn Dashboard</h2>
      <div style="position:relative; display:inline-block;">
        <input type="password" id="password-input" placeholder="Password" style="padding:10px; width:200px; border:1px solid #333; background:#0a0a0a; color:#fff; border-radius:4px; padding-right:35px;">
        <button type="button" id="toggle-pw" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#666; cursor:pointer; font-size:14px;">Show</button>
      </div>
      <br><br>
      <button id="login-btn" style="padding:10px 30px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;">Login</button>
      <div id="login-error" style="color:#ef4444; margin-top:10px; display:none;">Invalid password</div>
    </div>
  </div>

  <button class="refresh" onclick="loadData()">Refresh</button>
  <h1>Evryn Dashboard</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <!-- Agents Tab -->
  <div id="agents-tab">
    <h2>Status</h2>
    <div class="legend" id="status-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#22c55e;"></div> Active (5 min)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#666;"></div> Idle</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> Halted</div>
    </div>
    <div class="agent-grid" id="agent-grid">
      <div class="loading">Loading...</div>
    </div>

    <div class="collapsible-header" onclick="toggleMonthSpend()">
      <span class="collapse-icon" id="month-icon">&#9654;</span>
      <h2 style="margin: 0;">Month Spend: <span id="month-total-header">$0.00</span></h2>
    </div>
    <div class="month-spend-content" id="month-spend">
      <div id="month-breakdown"></div>
    </div>

    <h2>Usage Over Time</h2>
    <div class="chart-section">
      <div class="chart-controls" id="chart-controls">
        <div class="chart-controls-row">
          <span class="filters-label">Metric:</span>
          <button class="filter-btn active" data-metric="cost">Cost</button>
          <button class="filter-btn" data-metric="tokens">Tokens</button>
          <span class="separator">|</span>
          <span class="filters-label">Zoom:</span>
          <button class="filter-btn active" data-zoom="day">Day</button>
          <button class="filter-btn" data-zoom="week">Week</button>
          <button class="filter-btn" data-zoom="now">Now</button>
          <span class="separator">|</span>
          <input type="datetime-local" class="chart-datetime-input" id="chart-from" step="60">
          <span style="color:#666;">to</span>
          <input type="datetime-local" class="chart-datetime-input" id="chart-to" step="60">
        </div>
        <div class="chart-controls-row">
          <button class="filter-btn active" data-chart-action="total">Total</button>
          <button class="filter-btn" data-chart-action="all">All</button>
          <button class="filter-btn" data-chart-action="none">None</button>
          <span class="separator">|</span>
          <button class="filter-btn chart-agent-btn" data-chart-agent="thea" style="border-color:#22c55e;">Thea</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="lucas" style="border-color:#60a5fa;">Lucas</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="alex" style="border-color:#a855f7;">Alex</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="taylor" style="border-color:#eab308;">Taylor</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="dana" style="border-color:#f97316;">Dana</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="jordan" style="border-color:#ec4899;">Jordan</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="dominic" style="border-color:#2dd4bf;">Dominic</button>
          <button class="filter-btn chart-agent-btn" data-chart-agent="nathan" style="border-color:#f43f5e;">Nathan</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="usage-chart"></canvas>
      </div>
      <div class="range-slider-container" id="range-slider">
        <div class="range-slider-track" id="range-track"></div>
        <div class="range-slider-selected" id="range-selected">
          <div class="range-slider-handle left" id="range-handle-left"></div>
          <div class="range-slider-handle right" id="range-handle-right"></div>
        </div>
      </div>
    </div>

    <h2>Activity</h2>
    <div class="filters" id="filters">
      <span class="filters-label">Filter:</span>
      <button class="filter-btn" data-action="all">All</button>
      <button class="filter-btn" data-action="none">None</button>
      <span style="color:#333; margin: 0 4px;">|</span>
      <button class="filter-btn active" data-filter="api">API</button>
      <button class="filter-btn active" data-filter="scheduled">Scheduled</button>
      <button class="filter-btn active" data-filter="email-in">Emails In</button>
      <button class="filter-btn active" data-filter="email-out">Emails Out</button>
      <button class="filter-btn active" data-filter="inter_agent">Inter-Agent</button>
    </div>
    <div class="activity-wrapper" style="overflow-x: auto;">
      <table class="activity-table">
        <thead>
          <tr>
            <th class="col-time">Time</th>
            <th class="col-type">Type</th>
            <th class="col-agent">Agent</th>
            <th class="col-from">From</th>
            <th class="col-to">To</th>
            <th class="col-model">Model</th>
            <th class="col-tokens">Tokens</th>
            <th class="col-cost">Cost</th>
            <th class="col-subject">Subject</th>
            <th>Task/Message</th>
          </tr>
        </thead>
        <tbody id="activity-body">
          <tr><td colspan="10" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <button class="load-more" id="load-more" style="display:none;">Load More</button>
  </div>

  <script>
    const agents = ['Thea', 'Lucas', 'Alex', 'Taylor', 'Dana', 'Jordan', 'Dominic', 'Nathan'];
    let activeFilters = new Set(['api', 'scheduled', 'email-in', 'email-out', 'inter_agent']);
    let activityData = [];
    let allActivityData = [];
    let displayedCount = 10;
    let dateFrom = null;
    let dateTo = null;

    function getTodayPacific() {
      const now = new Date();
      // Get Pacific time date string
      return now.toLocaleDateString('en-CA', { timeZone: 'America/Los_Angeles' });
    }


    function initDateRange() {
      const today = getTodayPacific();
      dateFrom = today;
      dateTo = today;
    }

    // Called by the chart whenever visible range changes — syncs activity table
    function syncActivityDateRange() {
      if (typeof getChartVisibleRange !== 'function' || !usageChart || !usageChart.scales.x) return;
      const { min, max } = getChartVisibleRange();
      dateFrom = new Date(min).toISOString().split('T')[0];
      dateTo = new Date(max).toISOString().split('T')[0];
      displayedCount = 10;
      renderActivity();
    }

    function toggleMonthSpend() {
      document.getElementById('month-spend').classList.toggle('open');
      document.getElementById('month-icon').classList.toggle('open');
    }

    function renderMonthSpend(monthSpend) {
      document.getElementById('month-total-header').textContent = '$' + (monthSpend.total || 0).toFixed(2);
      let html = '';
      const agentOrder = ['thea', 'lucas', 'alex', 'taylor', 'dana', 'jordan', 'dominic', 'nathan'];
      const sortedAgents = agentOrder
        .map(name => [name, (monthSpend.byAgent || {})[name] || 0])
        .filter(([_, amount]) => amount > 0);
      sortedAgents.forEach(([agent, amount]) => {
        const capitalizedAgent = agent.charAt(0).toUpperCase() + agent.slice(1);
        html += `<div class="month-row"><span class="month-agent">${capitalizedAgent}</span><span class="month-amount">$${amount.toFixed(3)}</span></div>`;
      });
      html += `<div class="month-row month-total"><span>Total</span><span class="month-amount">$${(monthSpend.total || 0).toFixed(2)}</span></div>`;
      document.getElementById('month-breakdown').innerHTML = html;
    }

    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
             d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function getSpendClass(spend, alert, halt) {
      if (spend >= halt) return 'red';
      if (spend >= alert) return 'yellow';
      return 'green';
    }

    function getStatusClass(status) {
      if (status.halted) return 'halted';
      if (!status.lastActivity) return 'idle';
      const lastTime = new Date(status.lastActivity).getTime();
      const fiveMinAgo = Date.now() - 5 * 60 * 1000;
      return lastTime > fiveMinAgo ? 'active' : 'idle';
    }

    function truncate(str, len, alwaysTooltip = false) {
      if (!str) return '';
      const escaped = str.replace(/"/g, '&quot;').replace(/</g, '&lt;');
      if (str.length > len) {
        return `<span class="truncate" title="${escaped}">${str.substring(0, len)}...</span>`;
      }
      if (alwaysTooltip) {
        return `<span class="truncate" title="${escaped}">${escaped}</span>`;
      }
      return escaped;
    }

    function getActivityTypeClass(item) {
      if (item.type === 'api_call') {
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') return 'type-scheduled';
        if (item.trigger_type === 'inter_agent') return 'type-inter';
        return 'type-api';
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'type-inter';
        return item.direction === 'inbound' ? 'type-email-in' : 'type-email-out';
      }
      return '';
    }

    function getActivityTypeLabel(item) {
      if (item.type === 'api_call') {
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') return 'Sched';
        if (item.trigger_type === 'inter_agent') return 'Invoke';
        return 'API';
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'Invoke';
        return item.direction === 'inbound' ? 'In' : 'Out';
      }
      return '';
    }

    function getFilterKeys(item) {
      // Returns array of filter keys this item matches (can match multiple)
      const keys = [];
      if (item.type === 'api_call') {
        // Scheduled includes 'scheduled' and 'reflection' trigger types
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') {
          keys.push('scheduled');
        }
        // Inter-agent API calls
        if (item.trigger_type === 'inter_agent') {
          keys.push('inter_agent');
        }
        // All API calls also match 'api' filter
        keys.push('api');
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') {
          keys.push('inter_agent');
        } else {
          // Regular email messages
          keys.push(item.direction === 'inbound' ? 'email-in' : 'email-out');
        }
      }
      return keys.length > 0 ? keys : ['other'];
    }

    function matchesFilters(item) {
      const itemKeys = getFilterKeys(item);
      return itemKeys.some(key => activeFilters.has(key));
    }

    let authHeader = localStorage.getItem('evryn_auth') || null;

    function showLogin(showError = false) {
      document.getElementById('login-overlay').style.display = 'flex';
      document.getElementById('login-error').style.display = showError ? 'block' : 'none';
      document.getElementById('password-input').focus();
    }

    function hideLogin() {
      document.getElementById('login-overlay').style.display = 'none';
    }

    function doLogin() {
      const pass = document.getElementById('password-input').value;
      if (pass) {
        authHeader = 'Basic ' + btoa('evryn:' + pass);
        localStorage.setItem('evryn_auth', authHeader);
        hideLogin();
        loadData();
      }
    }

    // Multi-select filter toggling
    const allFilterKeys = ['api', 'scheduled', 'email-in', 'email-out', 'inter_agent'];

    function updateFilterButtons() {
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        if (activeFilters.has(btn.dataset.filter)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.getElementById('filters').addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-btn')) return;

      const action = e.target.dataset.action;
      const filter = e.target.dataset.filter;

      if (action === 'none') {
        activeFilters.clear();
        updateFilterButtons();
      } else if (action === 'all') {
        allFilterKeys.forEach(k => activeFilters.add(k));
        updateFilterButtons();
      } else if (filter) {
        if (activeFilters.has(filter)) {
          activeFilters.delete(filter);
          e.target.classList.remove('active');
        } else {
          activeFilters.add(filter);
          e.target.classList.add('active');
        }
      }
      displayedCount = 10;
      renderActivity();
    });

    // Load more
    document.getElementById('load-more').addEventListener('click', () => {
      displayedCount += 10;
      renderActivity();
    });

    function matchesDateRange(item) {
      if (!dateFrom || !dateTo) return true;
      const itemDate = item.created_at ? item.created_at.split('T')[0] : null;
      if (!itemDate) return true;
      return itemDate >= dateFrom && itemDate <= dateTo;
    }

    function renderActivity() {
      const filtered = allActivityData.filter(item => matchesFilters(item) && matchesDateRange(item));
      const toShow = filtered.slice(0, displayedCount);

      let html = '';
      if (toShow.length === 0) {
        html = '<tr><td colspan="10" class="loading">No activity matching filters</td></tr>';
      } else {
        toShow.forEach(item => {
          const isApi = item.type === 'api_call';
          const isMessage = item.type === 'message';
          const from = isMessage ? truncate(item.from_address, 25) : '';
          const to = isMessage ? truncate(item.to_address, 25) : '';
          const model = isApi ? (item.model || '') : '';
          const tokens = isApi ? (item.tokens || 0) : '';
          const cost = isApi ? '$' + (item.cost_usd || 0).toFixed(4) : '';
          const subject = isMessage ? truncate(item.subject, 30, true) : '';
          const task = isApi ? truncate(item.description, 50) : truncate(item.body, 50);

          html += `
            <tr>
              <td class="col-time">${formatDateTime(item.created_at)}</td>
              <td class="col-type"><span class="activity-type ${getActivityTypeClass(item)}">${getActivityTypeLabel(item)}</span></td>
              <td class="col-agent">${item.agent_name}</td>
              <td class="col-from">${from}</td>
              <td class="col-to">${to}</td>
              <td class="col-model">${model}</td>
              <td class="col-tokens">${tokens}</td>
              <td class="col-cost">${cost}</td>
              <td class="col-subject">${subject}</td>
              <td>${task}</td>
            </tr>
          `;
        });
      }
      document.getElementById('activity-body').innerHTML = html;
      document.getElementById('load-more').style.display = filtered.length > displayedCount ? 'block' : 'none';
    }

    async function loadData() {
      try {
        if (!authHeader) {
          showLogin();
          return;
        }

        const res = await fetch('/api/data', { headers: { 'Authorization': authHeader } });

        if (res.status === 401) {
          localStorage.removeItem('evryn_auth');
          authHeader = null;
          showLogin(true);
          return;
        }

        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();

        document.getElementById('timestamp').textContent = `${data.today} | Refreshed ${new Date().toLocaleTimeString()}`;

        // Build agent grid
        let agentHtml = '';
        agents.forEach(agent => {
          const agentKey = agent.toLowerCase();
          const status = data.agentStatus?.[agentKey] || { todaySpend: 0, halted: false, lastActivity: null };
          const spend = status.todaySpend || 0;
          const cls = getSpendClass(spend, data.alertThreshold, data.haltThreshold);
          const statusCls = getStatusClass(status);
          agentHtml += `
            <div class="agent-card ${cls} ${status.halted ? 'halted' : ''}">
              <div class="status-dot ${statusCls}" title="${statusCls}"></div>
              <div class="agent-name">${agent}</div>
              <div class="agent-spend ${cls}">$${spend.toFixed(3)}</div>
              <div class="agent-budget">/ $${data.budgetPerAgent.toFixed(2)}</div>
            </div>
          `;
        });
        document.getElementById('agent-grid').innerHTML = agentHtml;

        // Store all activity data and render
        allActivityData = data.activity || [];
        renderActivity();

        // Render month spend
        renderMonthSpend(data.monthSpend || { byAgent: {}, total: 0 });

        // Refresh usage chart
        loadUsageData();

      } catch (err) {
        console.error(err);
        document.getElementById('agent-grid').innerHTML = '<div class="error">Failed to load data</div>';
      }
    }

    // Set up login handlers
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-btn').addEventListener('click', doLogin);
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('toggle-pw').addEventListener('click', () => {
        const input = document.getElementById('password-input');
        const btn = document.getElementById('toggle-pw');
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Hide';
        } else {
          input.type = 'password';
          btn.textContent = 'Show';
        }
      });
    });

    // Initialize date range and load
    initDateRange();
    loadData();

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);

    // ========== Usage Chart ==========
    const agentColors = {
      thea: '#22c55e', lucas: '#60a5fa', alex: '#a855f7', taylor: '#eab308',
      dana: '#f97316', jordan: '#ec4899', dominic: '#2dd4bf', nathan: '#f43f5e'
    };
    const agentKeys = Object.keys(agentColors);
    let chartMetric = 'cost';
    let chartMode = 'total';
    let chartSelectedAgents = new Set();
    let lastClickedAgent = null; // last agent toggled on — renders on top
    let usageData = []; // raw bucketed data from API
    let usageChart = null;
    let chartDataMin = null; // earliest timestamp in loaded data
    let chartDataMax = null; // latest timestamp in loaded data
    let activeZoomPreset = 'day'; // 'day', 'week', or null if manually adjusted

    const DAY_MS = 24 * 60 * 60 * 1000;
    const WEEK_MS = 7 * DAY_MS;

    // Get "now" in Pacific time as a Date
    function nowPacific() {
      return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    }

    // Format a Date to datetime-local input value (YYYY-MM-DDTHH:MM)
    function toLocalInput(d) {
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function initChart() {
      const ctx = document.getElementById('usage-chart').getContext('2d');
      usageChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 200 },
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'EEE MMM d, h:mm a',
                displayFormats: {
                  minute: 'h:mm a',
                  hour: 'h a',
                  day: 'EEE MMM d',
                },
              },
              ticks: {
                color: '#666',
                maxTicksLimit: 12,
                autoSkip: true,
              },
              grid: { color: '#222' },
            },
            y: {
              ticks: { color: '#666' },
              grid: { color: '#222' },
              beginAtZero: true,
            }
          },
          plugins: {
            legend: { display: true, labels: { color: '#888', boxWidth: 12 } },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x',
                onPanComplete: () => onChartViewChanged(),
              },
              zoom: {
                wheel: {
                  enabled: true,
                  modifierKey: null,
                },
                mode: 'x',
                onZoomComplete: () => onChartViewChanged(),
              },
            },
          },
        },
      });
    }

    // Called after zoom/pan from plugin — sync UI
    function onChartViewChanged() {
      activeZoomPreset = null;
      updateZoomButtons();
      const { min, max } = getChartVisibleRange();
      updateTimeUnit(min, max);
      syncDatetimeInputsFromChart();
      updateRangeSlider();
    }

    function getChartVisibleRange() {
      const scale = usageChart.scales.x;
      return { min: scale.min, max: scale.max };
    }

    function updateTimeUnit(min, max) {
      const span = max - min;
      if (span <= DAY_MS * 1.5) {
        usageChart.options.scales.x.time.unit = 'hour';
      } else if (span <= WEEK_MS * 1.5) {
        usageChart.options.scales.x.time.unit = 'day';
      } else {
        usageChart.options.scales.x.time.unit = 'day';
      }
    }

    function setChartVisibleRange(min, max, noAnimation) {
      usageChart.options.scales.x.min = min;
      usageChart.options.scales.x.max = max;
      updateTimeUnit(min, max);
      usageChart.update(noAnimation ? 'none' : undefined);
      syncDatetimeInputsFromChart();
      updateRangeSlider();
    }

    function syncDatetimeInputsFromChart() {
      const { min, max } = getChartVisibleRange();
      document.getElementById('chart-from').value = toLocalInput(new Date(min));
      document.getElementById('chart-to').value = toLocalInput(new Date(max));
      // Sync activity table date range
      syncActivityDateRange();
    }

    function updateZoomButtons() {
      document.querySelectorAll('[data-zoom]').forEach(b => {
        if (b.dataset.zoom === 'now') return; // Now is never "active" state
        b.classList.toggle('active', b.dataset.zoom === activeZoomPreset);
      });
    }

    function applyZoomPreset(preset) {
      const now = nowPacific().getTime();
      let min, max;
      if (preset === 'day') {
        max = now + DAY_MS * 0.02; // small padding right
        min = max - DAY_MS;
      } else if (preset === 'week') {
        max = now + DAY_MS * 0.1;
        min = max - WEEK_MS;
      }
      activeZoomPreset = preset;
      updateZoomButtons();
      usageChart.resetZoom();
      setChartVisibleRange(min, max);
    }

    function jumpToNow() {
      const { min, max } = getChartVisibleRange();
      const span = max - min;
      const now = nowPacific().getTime();
      const newMax = now + span * 0.02;
      const newMin = newMax - span;
      setChartVisibleRange(newMin, newMax);
    }

    function buildChartDatasets() {
      const datasets = [];
      const metric = chartMetric;

      if (chartMode === 'total') {
        datasets.push({
          label: 'Total',
          data: usageData.map(d => {
            let sum = 0;
            Object.values(d.agents).forEach(a => { sum += a[metric]; });
            return { x: new Date(d.bucket).getTime(), y: metric === 'cost' ? parseFloat(sum.toFixed(4)) : sum };
          }),
          borderColor: '#60a5fa',
          backgroundColor: 'rgba(96,165,250,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 2,
        });
      } else {
        // Put lastClickedAgent last so it renders on top
        const showAgents = [...chartSelectedAgents].sort((a, b) => {
          if (a === lastClickedAgent) return 1;
          if (b === lastClickedAgent) return -1;
          return 0;
        });
        showAgents.forEach(agent => {
          datasets.push({
            label: agent.charAt(0).toUpperCase() + agent.slice(1),
            data: usageData.map(d => {
              const a = d.agents[agent];
              const val = a ? a[metric] : 0;
              return { x: new Date(d.bucket).getTime(), y: metric === 'cost' ? parseFloat(val.toFixed(4)) : val };
            }),
            borderColor: agentColors[agent],
            backgroundColor: 'transparent',
            tension: 0.3,
            pointRadius: 2,
          });
        });
      }
      return datasets;
    }

    function renderChart() {
      if (!usageChart) return;
      const { min, max } = usageChart.scales.x ? getChartVisibleRange() : { min: null, max: null };
      usageChart.data.datasets = buildChartDatasets();
      usageChart.options.scales.y.title = { display: true, text: chartMetric === 'cost' ? 'USD' : 'Tokens', color: '#666' };
      // Preserve current view if we have one
      if (min && max) {
        usageChart.options.scales.x.min = min;
        usageChart.options.scales.x.max = max;
      }
      usageChart.update('none');
      syncDatetimeInputsFromChart();
      updateRangeSlider();
    }

    async function loadUsageData() {
      if (!authHeader) return;
      try {
        // Always fetch last 30 days of minute-level data for smooth zooming
        const now = nowPacific();
        const from = new Date(now.getTime() - 30 * DAY_MS);
        const fromStr = from.toISOString();
        const toStr = new Date(now.getTime() + DAY_MS).toISOString();
        const res = await fetch(`/api/usage?granularity=minute&from=${fromStr}&to=${toStr}`, {
          headers: { 'Authorization': authHeader }
        });
        if (!res.ok) return;
        const json = await res.json();
        usageData = json.data || [];
        if (usageData.length > 0) {
          chartDataMin = new Date(usageData[0].bucket).getTime();
          chartDataMax = new Date(usageData[usageData.length - 1].bucket).getTime();
        } else {
          chartDataMin = from.getTime();
          chartDataMax = now.getTime();
        }
        // Build datasets and apply current zoom
        usageChart.data.datasets = buildChartDatasets();
        usageChart.options.scales.y.title = { display: true, text: chartMetric === 'cost' ? 'USD' : 'Tokens', color: '#666' };
        if (activeZoomPreset) {
          applyZoomPreset(activeZoomPreset);
        } else {
          usageChart.update('none');
          syncDatetimeInputsFromChart();
          updateRangeSlider();
        }
      } catch (e) {
        console.error('Usage chart error:', e);
      }
    }

    // ========== Horizontal scroll to pan ==========
    document.getElementById('usage-chart').addEventListener('wheel', (e) => {
      // Handle horizontal scroll (wheel tilt / trackpad horizontal swipe)
      if (Math.abs(e.deltaX) > Math.abs(e.deltaY) && e.deltaX !== 0) {
        e.preventDefault();
        const { min, max } = getChartVisibleRange();
        const span = max - min;
        const panAmount = span * 0.05 * Math.sign(e.deltaX);
        setChartVisibleRange(min + panAmount, max + panAmount, true);
        activeZoomPreset = null;
        updateZoomButtons();
      }
      // Shift+wheel vertical also pans
      if (e.shiftKey && Math.abs(e.deltaY) > 0) {
        e.preventDefault();
        const { min, max } = getChartVisibleRange();
        const span = max - min;
        const panAmount = span * 0.05 * Math.sign(e.deltaY);
        setChartVisibleRange(min + panAmount, max + panAmount, true);
        activeZoomPreset = null;
        updateZoomButtons();
      }
    }, { passive: false });

    // ========== Range Slider ==========
    const rangeSlider = document.getElementById('range-slider');
    const rangeSelected = document.getElementById('range-selected');
    let sliderDragging = null; // 'left', 'right', 'middle'
    let sliderDragStartX = 0;
    let sliderDragStartLeft = 0;
    let sliderDragStartRight = 0;
    let sliderDragStartWidth = 0;

    function getSliderWidth() { return rangeSlider.getBoundingClientRect().width; }

    function timeToSliderPct(t) {
      if (!chartDataMin || !chartDataMax || chartDataMax === chartDataMin) return 0;
      // Use a 30-day window for the slider
      const now = nowPacific().getTime();
      const sliderMin = now - 30 * DAY_MS;
      const sliderMax = now + DAY_MS;
      return Math.max(0, Math.min(1, (t - sliderMin) / (sliderMax - sliderMin)));
    }

    function sliderPctToTime(pct) {
      const now = nowPacific().getTime();
      const sliderMin = now - 30 * DAY_MS;
      const sliderMax = now + DAY_MS;
      return sliderMin + pct * (sliderMax - sliderMin);
    }

    function updateRangeSlider() {
      if (!usageChart || !usageChart.scales.x) return;
      const { min, max } = getChartVisibleRange();
      const leftPct = timeToSliderPct(min) * 100;
      const rightPct = timeToSliderPct(max) * 100;
      rangeSelected.style.left = leftPct + '%';
      rangeSelected.style.width = Math.max(0.5, rightPct - leftPct) + '%';
    }

    function onSliderMouseDown(e) {
      e.preventDefault();
      const target = e.target;
      const rect = rangeSlider.getBoundingClientRect();
      sliderDragStartX = e.clientX;

      sliderDragStartLeft = parseFloat(rangeSelected.style.left) || 0;
      sliderDragStartWidth = parseFloat(rangeSelected.style.width) || 10;
      sliderDragStartRight = sliderDragStartLeft + sliderDragStartWidth;

      if (target.id === 'range-handle-left') {
        sliderDragging = 'left';
      } else if (target.id === 'range-handle-right') {
        sliderDragging = 'right';
      } else if (target.id === 'range-selected') {
        sliderDragging = 'middle';
      } else {
        // Click on track — jump the window center there
        const clickPct = ((e.clientX - rect.left) / rect.width) * 100;
        const widthPct = parseFloat(rangeSelected.style.width) || 10;
        let newLeft = clickPct - widthPct / 2;
        newLeft = Math.max(0, Math.min(100 - widthPct, newLeft));
        const newMin = sliderPctToTime(newLeft / 100);
        const newMax = sliderPctToTime((newLeft + widthPct) / 100);
        activeZoomPreset = null;
        updateZoomButtons();
        setChartVisibleRange(newMin, newMax);
        return;
      }
      document.addEventListener('mousemove', onSliderMouseMove);
      document.addEventListener('mouseup', onSliderMouseUp);
    }

    function onSliderMouseMove(e) {
      if (!sliderDragging) return;
      const rect = rangeSlider.getBoundingClientRect();
      const dx = ((e.clientX - sliderDragStartX) / rect.width) * 100;

      if (sliderDragging === 'left') {
        // Move left edge, right edge stays fixed at sliderDragStartRight
        let newLeft = Math.max(0, Math.min(sliderDragStartRight - 1, sliderDragStartLeft + dx));
        let newWidth = sliderDragStartRight - newLeft;
        rangeSelected.style.left = newLeft + '%';
        rangeSelected.style.width = newWidth + '%';
        const newMin = sliderPctToTime(newLeft / 100);
        const fixedMax = sliderPctToTime(sliderDragStartRight / 100);
        usageChart.options.scales.x.min = newMin;
        usageChart.options.scales.x.max = fixedMax;
        usageChart.update('none');
        syncDatetimeInputsFromChart();
      } else if (sliderDragging === 'right') {
        // Move right edge, left edge stays fixed at sliderDragStartLeft
        let newRight = Math.min(100, Math.max(sliderDragStartLeft + 1, sliderDragStartRight + dx));
        let newWidth = newRight - sliderDragStartLeft;
        rangeSelected.style.width = newWidth + '%';
        const fixedMin = sliderPctToTime(sliderDragStartLeft / 100);
        const newMax = sliderPctToTime(newRight / 100);
        usageChart.options.scales.x.min = fixedMin;
        usageChart.options.scales.x.max = newMax;
        usageChart.update('none');
        syncDatetimeInputsFromChart();
      } else if (sliderDragging === 'middle') {
        let newLeft = Math.max(0, Math.min(100 - sliderDragStartWidth, sliderDragStartLeft + dx));
        rangeSelected.style.left = newLeft + '%';
        const newMin = sliderPctToTime(newLeft / 100);
        const newMax = sliderPctToTime((newLeft + sliderDragStartWidth) / 100);
        usageChart.options.scales.x.min = newMin;
        usageChart.options.scales.x.max = newMax;
        usageChart.update('none');
        syncDatetimeInputsFromChart();
      }
      activeZoomPreset = null;
      updateZoomButtons();
    }

    function onSliderMouseUp() {
      sliderDragging = null;
      document.removeEventListener('mousemove', onSliderMouseMove);
      document.removeEventListener('mouseup', onSliderMouseUp);
    }

    rangeSlider.addEventListener('mousedown', onSliderMouseDown);

    // ========== Chart Controls ==========
    document.getElementById('chart-controls').addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-btn');
      if (!btn) return;

      const metric = btn.dataset.metric;
      const zoom = btn.dataset.zoom;
      const action = btn.dataset.chartAction;
      const agent = btn.dataset.chartAgent;

      if (metric) {
        chartMetric = metric;
        document.querySelectorAll('[data-metric]').forEach(b => b.classList.toggle('active', b.dataset.metric === metric));
        renderChart();
      } else if (zoom === 'day' || zoom === 'week') {
        applyZoomPreset(zoom);
      } else if (zoom === 'now') {
        jumpToNow();
      } else if (action === 'total') {
        chartMode = 'total';
        chartSelectedAgents.clear();
        document.querySelectorAll('[data-chart-action]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('[data-chart-agent]').forEach(b => b.classList.remove('active'));
        renderChart();
      } else if (action === 'all') {
        chartMode = 'individual';
        lastClickedAgent = null;
        agentKeys.forEach(a => chartSelectedAgents.add(a));
        document.querySelectorAll('[data-chart-action]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('[data-chart-agent]').forEach(b => b.classList.add('active'));
        renderChart();
      } else if (action === 'none') {
        chartMode = 'individual';
        chartSelectedAgents.clear();
        document.querySelectorAll('[data-chart-action]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('[data-chart-agent]').forEach(b => b.classList.remove('active'));
        renderChart();
      } else if (agent) {
        chartMode = 'individual';
        if (chartSelectedAgents.has(agent)) {
          chartSelectedAgents.delete(agent);
          btn.classList.remove('active');
          if (lastClickedAgent === agent) lastClickedAgent = null;
        } else {
          chartSelectedAgents.add(agent);
          btn.classList.add('active');
          lastClickedAgent = agent;
        }
        document.querySelectorAll('[data-chart-action]').forEach(b => b.classList.remove('active'));
        if (chartSelectedAgents.size === agentKeys.length) {
          document.querySelector('[data-chart-action="all"]').classList.add('active');
        } else if (chartSelectedAgents.size === 0) {
          document.querySelector('[data-chart-action="none"]').classList.add('active');
        }
        renderChart();
      }
    });

    // Datetime picker changes → update chart view
    document.getElementById('chart-from').addEventListener('change', (e) => {
      const min = new Date(e.target.value).getTime();
      const { max } = getChartVisibleRange();
      if (min < max) {
        activeZoomPreset = null;
        updateZoomButtons();
        setChartVisibleRange(min, max);
      }
    });
    document.getElementById('chart-to').addEventListener('change', (e) => {
      const max = new Date(e.target.value).getTime();
      const { min } = getChartVisibleRange();
      if (max > min) {
        activeZoomPreset = null;
        updateZoomButtons();
        setChartVisibleRange(min, max);
      }
    });

    // Initialize chart and load data
    initChart();
    loadUsageData();

  </script>
</body>
</html>
