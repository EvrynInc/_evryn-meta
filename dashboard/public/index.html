<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evryn Agents Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 16px 12px;
      line-height: 1.5;
      max-width: 100%;
    }
    h1 { color: #fff; margin-bottom: 16px; font-size: 1.4rem; }
    h2 { color: #888; margin: 20px 0 10px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 24px; }

    .card {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 12px 14px;
      border: 1px solid #333;
    }
    .card.green { border-color: #22c55e; }
    .card.yellow { border-color: #eab308; }
    .card.red { border-color: #ef4444; }

    .agent-name { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
    .spend { font-size: 1.2rem; font-weight: 600; }
    .spend.green { color: #22c55e; }
    .spend.yellow { color: #eab308; }
    .spend.red { color: #ef4444; }
    .budget { font-size: 0.75rem; color: #666; margin-top: 4px; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { text-align: left; padding: 6px 8px; border-bottom: 1px solid #222; }
    th { color: #888; font-weight: 500; font-size: 0.75rem; text-transform: uppercase; }
    td { font-size: 0.8rem; }
    tr:hover { background: #1a1a1a; }

    .truncate { cursor: help; }

    .time { color: #666; }
    .agent { color: #60a5fa; }
    .cost { font-family: monospace; }
    .direction-in { color: #22c55e; }
    .direction-out { color: #f97316; }

    .loading { color: #666; padding: 40px; text-align: center; }
    .error { color: #ef4444; padding: 40px; text-align: center; }

    .refresh {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .refresh:hover { background: #444; }

    .timestamp { color: #666; font-size: 0.75rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div id="login-overlay" style="display:none; position:fixed; inset:0; background:#0a0a0a; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:40px; border-radius:8px; border:1px solid #333; text-align:center;">
      <h2 style="color:#fff; margin-bottom:20px;">Evryn Dashboard</h2>
      <div style="position:relative; display:inline-block;">
        <input type="password" id="password-input" placeholder="Password" style="padding:10px; width:200px; border:1px solid #333; background:#0a0a0a; color:#fff; border-radius:4px; padding-right:35px;">
        <button type="button" id="toggle-pw" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#666; cursor:pointer; font-size:14px;">üëÅ</button>
      </div>
      <br style="margin-bottom:10px;">
      <br>
      <button id="login-btn" style="padding:10px 30px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;">Login</button>
      <div id="login-error" style="color:#ef4444; margin-top:10px; display:none;">Invalid password</div>
    </div>
  </div>
  <button class="refresh" onclick="loadData()">Refresh</button>
  <h1>Evryn Agents</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <h2>Today's Spend</h2>
  <div class="grid" id="spend-grid">
    <div class="loading">Loading...</div>
  </div>

  <h2>Recent API Calls</h2>
  <table id="api-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Agent</th>
        <th>Model</th>
        <th>Tokens</th>
        <th>Cost</th>
        <th>Task</th>
      </tr>
    </thead>
    <tbody id="api-body">
      <tr><td colspan="6" class="loading">Loading...</td></tr>
    </tbody>
  </table>

  <h2>Recent Messages</h2>
  <table id="msg-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Agent</th>
        <th>Dir</th>
        <th>From/To</th>
        <th>Subject</th>
      </tr>
    </thead>
    <tbody id="msg-body">
      <tr><td colspan="5" class="loading">Loading...</td></tr>
    </tbody>
  </table>

  <script>
    const agents = ['thea', 'taylor', 'jordan', 'dana', 'dominic', 'nathan', 'lucas', 'alex'];

    function formatTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + formatTime(isoString);
    }

    function getSpendClass(spend, budget, alert, halt) {
      if (spend >= halt) return 'red';
      if (spend >= alert) return 'yellow';
      return 'green';
    }

    function truncate(str, len) {
      if (!str) return '-';
      const escaped = str.replace(/"/g, '&quot;').replace(/</g, '&lt;');
      if (str.length > len) {
        return `<span class="truncate" title="${escaped}">${str.substring(0, len)}...</span>`;
      }
      return escaped;
    }

    let authHeader = localStorage.getItem('evryn_auth') || null;

    function showLogin(showError = false) {
      document.getElementById('login-overlay').style.display = 'flex';
      document.getElementById('login-error').style.display = showError ? 'block' : 'none';
      document.getElementById('password-input').focus();
    }

    function hideLogin() {
      document.getElementById('login-overlay').style.display = 'none';
    }

    function doLogin() {
      const pass = document.getElementById('password-input').value;
      if (pass) {
        authHeader = 'Basic ' + btoa('evryn:' + pass);
        localStorage.setItem('evryn_auth', authHeader);
        hideLogin();
        loadData();
      }
    }

    // Set up login handlers
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-btn').addEventListener('click', doLogin);
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('toggle-pw').addEventListener('click', () => {
        const input = document.getElementById('password-input');
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    async function loadData() {
      try {
        if (!authHeader) {
          showLogin();
          return;
        }

        const res = await fetch('/api/data', {
          headers: { 'Authorization': authHeader }
        });

        if (res.status === 401) {
          localStorage.removeItem('evryn_auth');
          authHeader = null;
          showLogin(true);
          return;
        }

        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();

        // Update timestamp
        document.getElementById('timestamp').textContent =
          `Data for ${data.today} | Last refreshed: ${new Date().toLocaleTimeString()}`;

        // Build spend grid
        const spendMap = {};
        (data.dailySpend || []).forEach(s => { spendMap[s.agent_name] = s.total_cost_usd || 0; });

        let spendHtml = '';
        agents.forEach(agent => {
          const spend = spendMap[agent] || 0;
          const cls = getSpendClass(spend, data.budgetPerAgent, data.alertThreshold, data.haltThreshold);
          spendHtml += `
            <div class="card ${cls}">
              <div class="agent-name">${agent}</div>
              <div class="spend ${cls}">$${spend.toFixed(3)}</div>
              <div class="budget">/ $${data.budgetPerAgent.toFixed(2)}</div>
            </div>
          `;
        });
        document.getElementById('spend-grid').innerHTML = spendHtml;

        // Build API calls table
        let apiHtml = '';
        (data.apiCalls || []).slice(0, 20).forEach(call => {
          apiHtml += `
            <tr>
              <td class="time">${formatDate(call.created_at)}</td>
              <td class="agent">${call.agent_name}</td>
              <td>${call.model || '-'}</td>
              <td>${(call.input_tokens || 0) + (call.output_tokens || 0)}</td>
              <td class="cost">$${(call.cost_usd || 0).toFixed(4)}</td>
              <td>${truncate(call.task_description, 50)}</td>
            </tr>
          `;
        });
        document.getElementById('api-body').innerHTML = apiHtml || '<tr><td colspan="6">No API calls yet</td></tr>';

        // Build messages table
        let msgHtml = '';
        (data.messages || []).slice(0, 15).forEach(msg => {
          const dirClass = msg.direction === 'inbound' ? 'direction-in' : 'direction-out';
          const addr = msg.direction === 'inbound' ? msg.from_address : msg.to_address;
          msgHtml += `
            <tr>
              <td class="time">${formatDate(msg.created_at)}</td>
              <td class="agent">${msg.agent_name}</td>
              <td class="${dirClass}">${msg.direction === 'inbound' ? 'IN' : 'OUT'}</td>
              <td>${truncate(addr, 25)}</td>
              <td>${truncate(msg.subject, 40)}</td>
            </tr>
          `;
        });
        document.getElementById('msg-body').innerHTML = msgHtml || '<tr><td colspan="5">No messages yet</td></tr>';

      } catch (err) {
        console.error(err);
        document.getElementById('spend-grid').innerHTML = '<div class="error">Failed to load data</div>';
      }
    }

    // Load on page load
    loadData();

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
  </script>
</body>
</html>
