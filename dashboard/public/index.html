<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evryn Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 16px;
      line-height: 1.5;
    }
    h1 { color: #fff; margin-bottom: 4px; font-size: 1.4rem; }
    h2 { color: #888; margin: 16px 0 8px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

    /* Main Tabs */
    .main-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid #333; }
    .main-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 0.95rem;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .main-tab.active { color: #fff; border-bottom-color: #60a5fa; }
    .main-tab:hover:not(.active) { color: #aaa; }
    .main-tab-content { display: none; }
    .main-tab-content.active { display: block; }

    /* Agent Grid */
    .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 16px; }
    .agent-card {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 10px 12px;
      border: 1px solid #333;
      position: relative;
    }
    .agent-card.green { border-color: #22c55e; }
    .agent-card.yellow { border-color: #eab308; }
    .agent-card.red { border-color: #ef4444; }
    .agent-card.halted { opacity: 0.6; }
    .agent-name { font-size: 0.8rem; color: #fff; font-weight: 500; }
    .agent-spend { font-size: 1rem; font-weight: 600; margin-top: 2px; }
    .agent-spend.green { color: #22c55e; }
    .agent-spend.yellow { color: #eab308; }
    .agent-spend.red { color: #ef4444; }
    .agent-budget { font-size: 0.7rem; color: #666; }
    .status-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.active { background: #22c55e; }
    .status-dot.halted { background: #ef4444; }
    .status-dot.idle { background: #666; }

    /* Legends */
    .legend { display: flex; gap: 16px; font-size: 0.7rem; color: #666; margin-bottom: 12px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .legend-bar { width: 12px; height: 3px; border-radius: 1px; }

    /* Filters */
    .filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
    .filters-label { font-size: 0.75rem; color: #666; margin-right: 4px; }
    .filter-btn {
      padding: 4px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      color: #888;
      font-size: 0.75rem;
    }
    .filter-btn.active { background: #333; color: #fff; border-color: #555; }
    .filter-btn:hover:not(.active) { background: #222; }

    /* Activity Table */
    .activity-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-bottom: 16px; }
    .activity-table th {
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid #333;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.65rem;
      letter-spacing: 0.5px;
    }
    .activity-table td {
      padding: 6px;
      border: 1px solid #333;
      color: #888;
      vertical-align: top;
    }
    .activity-table tr:hover td { background: #1a1a1a; }
    .activity-table .col-time { width: 110px; white-space: nowrap; color: #666; }
    .activity-table .col-type { width: 50px; }
    .activity-table .col-agent { width: 60px; color: #60a5fa; }
    .activity-table .col-from, .activity-table .col-to { width: 130px; }
    .activity-table .col-model { width: 55px; }
    .activity-table .col-tokens { width: 50px; text-align: right; }
    .activity-table .col-cost { width: 55px; text-align: right; }
    .activity-table .col-subject { min-width: 120px; max-width: 200px; }
    .activity-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.6rem;
      text-transform: uppercase;
    }
    .type-api { background: #1e3a5f; color: #60a5fa; }
    .type-scheduled { background: #1e3a3a; color: #2dd4bf; }
    .type-email-in { background: #14532d; color: #22c55e; }
    .type-email-out { background: #7c2d12; color: #f97316; }
    .type-inter { background: #4a1d6a; color: #a855f7; }

    .load-more {
      display: block;
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
    }
    .load-more:hover { background: #222; color: #fff; }

    /* Month Spend Collapsible */
    .collapsible-header { display: flex; align-items: center; cursor: pointer; gap: 8px; }
    .collapsible-header:hover { opacity: 0.8; }
    .collapse-icon { transition: transform 0.2s; font-size: 0.7rem; color: #666; }
    .collapse-icon.open { transform: rotate(90deg); }
    .month-spend-content { display: none; margin-top: 8px; background: #111; border-radius: 6px; padding: 12px; margin-bottom: 16px; max-width: 280px; }
    .month-spend-content.open { display: block; }
    .month-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem; border-bottom: 1px solid #1a1a1a; }
    .month-row:last-child { border-bottom: none; }
    .month-agent { color: #888; }
    .month-amount { color: #60a5fa; }
    .month-total { margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; font-weight: 600; }

    /* Kanban */
    .kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; min-height: 400px; }
    @media (max-width: 900px) { .kanban { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .kanban { grid-template-columns: 1fr; } }
    .kanban-column { background: #111; border-radius: 6px; padding: 12px; min-height: 200px; }
    .kanban-header {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #222;
    }
    .kanban-header span { color: #888; font-size: 0.7rem; margin-left: 4px; }
    .backlog-item {
      background: #1a1a1a;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid #333;
      cursor: pointer;
    }
    .backlog-item:hover { background: #222; }
    .backlog-item.priority-urgent { border-left-color: #ec4899; }
    .backlog-item.priority-high { border-left-color: #ef4444; }
    .backlog-item.priority-medium { border-left-color: #eab308; }
    .backlog-item.priority-low { border-left-color: #22c55e; }
    .backlog-title { font-size: 0.8rem; color: #fff; margin-bottom: 4px; }
    .backlog-meta { font-size: 0.7rem; color: #666; }
    .backlog-category {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 2px;
      font-size: 0.6rem;
      text-transform: uppercase;
      background: #222;
      color: #888;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #333;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .modal-title { font-size: 1.1rem; color: #fff; }
    .modal-close { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; line-height: 1; }
    .modal-close:hover { color: #fff; }
    .modal-field { margin-bottom: 12px; }
    .modal-label { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-bottom: 4px; }
    .modal-value { font-size: 0.85rem; color: #e0e0e0; }
    .modal-priority { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.7rem; text-transform: uppercase; }
    .modal-priority.urgent { background: #ec4899; color: #fff; }
    .modal-priority.high { background: #ef4444; color: #fff; }
    .modal-priority.medium { background: #eab308; color: #000; }
    .modal-priority.low { background: #22c55e; color: #000; }

    /* Misc */
    .truncate { cursor: help; }
    .loading { color: #666; padding: 40px; text-align: center; }
    .error { color: #ef4444; padding: 40px; text-align: center; }
    .refresh { position: fixed; top: 16px; right: 16px; background: #333; border: none; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; z-index: 50; }
    .refresh:hover { background: #444; }
    .timestamp { color: #666; font-size: 0.75rem; margin-bottom: 16px; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="login-overlay" style="display:none; position:fixed; inset:0; background:#0a0a0a; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:40px; border-radius:8px; border:1px solid #333; text-align:center;">
      <h2 style="color:#fff; margin-bottom:20px;">Evryn Dashboard</h2>
      <div style="position:relative; display:inline-block;">
        <input type="password" id="password-input" placeholder="Password" style="padding:10px; width:200px; border:1px solid #333; background:#0a0a0a; color:#fff; border-radius:4px; padding-right:35px;">
        <button type="button" id="toggle-pw" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#666; cursor:pointer; font-size:14px;">Show</button>
      </div>
      <br><br>
      <button id="login-btn" style="padding:10px 30px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;">Login</button>
      <div id="login-error" style="color:#ef4444; margin-top:10px; display:none;">Invalid password</div>
    </div>
  </div>

  <!-- Backlog Item Modal -->
  <div class="modal-overlay" id="backlog-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title"></div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <button class="refresh" onclick="loadData()">Refresh</button>
  <h1>Evryn Dashboard</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <!-- Main Tabs -->
  <div class="main-tabs">
    <button class="main-tab active" data-tab="agents">Agents</button>
    <button class="main-tab" data-tab="progress">Progress</button>
  </div>

  <!-- Agents Tab -->
  <div id="agents-tab" class="main-tab-content active">
    <h2>Status</h2>
    <div class="legend" id="status-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#22c55e;"></div> Active (5 min)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#666;"></div> Idle</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> Halted</div>
    </div>
    <div class="agent-grid" id="agent-grid">
      <div class="loading">Loading...</div>
    </div>

    <div class="collapsible-header" onclick="toggleMonthSpend()">
      <span class="collapse-icon" id="month-icon">&#9654;</span>
      <h2 style="margin: 0;">Month Spend: <span id="month-total-header">$0.00</span></h2>
    </div>
    <div class="month-spend-content" id="month-spend">
      <div id="month-breakdown"></div>
    </div>

    <h2>Activity</h2>
    <div class="filters" id="filters">
      <span class="filters-label">Filter:</span>
      <button class="filter-btn" data-action="none">None</button>
      <button class="filter-btn" data-action="all">All</button>
      <span style="color:#333; margin: 0 4px;">|</span>
      <button class="filter-btn active" data-filter="api">API</button>
      <button class="filter-btn active" data-filter="scheduled">Scheduled</button>
      <button class="filter-btn active" data-filter="email-in">Emails In</button>
      <button class="filter-btn active" data-filter="email-out">Emails Out</button>
      <button class="filter-btn active" data-filter="inter_agent">Inter-Agent</button>
    </div>
    <div class="activity-wrapper" style="overflow-x: auto;">
      <table class="activity-table">
        <thead>
          <tr>
            <th class="col-time">Time</th>
            <th class="col-type">Type</th>
            <th class="col-agent">Agent</th>
            <th class="col-from">From</th>
            <th class="col-to">To</th>
            <th class="col-model">Model</th>
            <th class="col-tokens">Tokens</th>
            <th class="col-cost">Cost</th>
            <th class="col-subject">Subject</th>
            <th>Task/Message</th>
          </tr>
        </thead>
        <tbody id="activity-body">
          <tr><td colspan="10" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <button class="load-more" id="load-more" style="display:none;">Load More</button>
  </div>

  <!-- Progress Tab -->
  <div id="progress-tab" class="main-tab-content">
    <h2>Backlog</h2>
    <div class="legend">
      <span style="margin-right: 8px;">Priority:</span>
      <div class="legend-item"><div class="legend-bar" style="background:#ec4899;"></div> Urgent</div>
      <div class="legend-item"><div class="legend-bar" style="background:#ef4444;"></div> High</div>
      <div class="legend-item"><div class="legend-bar" style="background:#eab308;"></div> Medium</div>
      <div class="legend-item"><div class="legend-bar" style="background:#22c55e;"></div> Low</div>
    </div>
    <div class="kanban" id="kanban">
      <div class="kanban-column" id="col-pending">
        <div class="kanban-header">Pending <span id="count-pending"></span></div>
      </div>
      <div class="kanban-column" id="col-in_progress">
        <div class="kanban-header">In Progress <span id="count-in_progress"></span></div>
      </div>
      <div class="kanban-column" id="col-blocked">
        <div class="kanban-header">Blocked <span id="count-blocked"></span></div>
      </div>
      <div class="kanban-column" id="col-completed">
        <div class="kanban-header">Completed <span id="count-completed"></span></div>
      </div>
    </div>
  </div>

  <script>
    const agents = ['Thea', 'Taylor', 'Jordan', 'Dana', 'Dominic', 'Nathan', 'Lucas', 'Alex'];
    let activeFilters = new Set(['api', 'scheduled', 'email-in', 'email-out', 'inter_agent']);
    let activityData = [];
    let allActivityData = [];
    let displayedCount = 10;
    let backlogData = [];

    function toggleMonthSpend() {
      document.getElementById('month-spend').classList.toggle('open');
      document.getElementById('month-icon').classList.toggle('open');
    }

    function renderMonthSpend(monthSpend) {
      document.getElementById('month-total-header').textContent = '$' + (monthSpend.total || 0).toFixed(2);
      let html = '';
      const sortedAgents = Object.entries(monthSpend.byAgent || {}).sort((a, b) => b[1] - a[1]);
      sortedAgents.forEach(([agent, amount]) => {
        html += `<div class="month-row"><span class="month-agent">${agent}</span><span class="month-amount">$${amount.toFixed(3)}</span></div>`;
      });
      html += `<div class="month-row month-total"><span>Total</span><span class="month-amount">$${(monthSpend.total || 0).toFixed(2)}</span></div>`;
      document.getElementById('month-breakdown').innerHTML = html;
    }

    function formatDateTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
             d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function getSpendClass(spend, alert, halt) {
      if (spend >= halt) return 'red';
      if (spend >= alert) return 'yellow';
      return 'green';
    }

    function getStatusClass(status) {
      if (status.halted) return 'halted';
      if (!status.lastActivity) return 'idle';
      const lastTime = new Date(status.lastActivity).getTime();
      const fiveMinAgo = Date.now() - 5 * 60 * 1000;
      return lastTime > fiveMinAgo ? 'active' : 'idle';
    }

    function truncate(str, len, alwaysTooltip = false) {
      if (!str) return '';
      const escaped = str.replace(/"/g, '&quot;').replace(/</g, '&lt;');
      if (str.length > len) {
        return `<span class="truncate" title="${escaped}">${str.substring(0, len)}...</span>`;
      }
      if (alwaysTooltip) {
        return `<span class="truncate" title="${escaped}">${escaped}</span>`;
      }
      return escaped;
    }

    function getActivityTypeClass(item) {
      if (item.type === 'api_call') {
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') return 'type-scheduled';
        if (item.trigger_type === 'inter_agent') return 'type-inter';
        return 'type-api';
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'type-inter';
        return item.direction === 'inbound' ? 'type-email-in' : 'type-email-out';
      }
      return '';
    }

    function getActivityTypeLabel(item) {
      if (item.type === 'api_call') {
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') return 'Sched';
        if (item.trigger_type === 'inter_agent') return 'Invoke';
        return 'API';
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'Invoke';
        return item.direction === 'inbound' ? 'In' : 'Out';
      }
      return '';
    }

    function getFilterKeys(item) {
      // Returns array of filter keys this item matches (can match multiple)
      const keys = [];
      if (item.type === 'api_call') {
        // Scheduled includes 'scheduled' and 'reflection' trigger types
        if (item.trigger_type === 'scheduled' || item.trigger_type === 'reflection') {
          keys.push('scheduled');
        }
        // Inter-agent API calls
        if (item.trigger_type === 'inter_agent') {
          keys.push('inter_agent');
        }
        // All API calls also match 'api' filter
        keys.push('api');
      }
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') {
          keys.push('inter_agent');
        } else {
          // Regular email messages
          keys.push(item.direction === 'inbound' ? 'email-in' : 'email-out');
        }
      }
      return keys.length > 0 ? keys : ['other'];
    }

    function matchesFilters(item) {
      const itemKeys = getFilterKeys(item);
      return itemKeys.some(key => activeFilters.has(key));
    }

    let authHeader = localStorage.getItem('evryn_auth') || null;

    function showLogin(showError = false) {
      document.getElementById('login-overlay').style.display = 'flex';
      document.getElementById('login-error').style.display = showError ? 'block' : 'none';
      document.getElementById('password-input').focus();
    }

    function hideLogin() {
      document.getElementById('login-overlay').style.display = 'none';
    }

    function doLogin() {
      const pass = document.getElementById('password-input').value;
      if (pass) {
        authHeader = 'Basic ' + btoa('evryn:' + pass);
        localStorage.setItem('evryn_auth', authHeader);
        hideLogin();
        loadData();
      }
    }

    // Main tab switching
    document.querySelectorAll('.main-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // Multi-select filter toggling
    const allFilterKeys = ['api', 'scheduled', 'email-in', 'email-out', 'inter_agent'];

    function updateFilterButtons() {
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        if (activeFilters.has(btn.dataset.filter)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.getElementById('filters').addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-btn')) return;

      const action = e.target.dataset.action;
      const filter = e.target.dataset.filter;

      if (action === 'none') {
        activeFilters.clear();
        updateFilterButtons();
      } else if (action === 'all') {
        allFilterKeys.forEach(k => activeFilters.add(k));
        updateFilterButtons();
      } else if (filter) {
        if (activeFilters.has(filter)) {
          activeFilters.delete(filter);
          e.target.classList.remove('active');
        } else {
          activeFilters.add(filter);
          e.target.classList.add('active');
        }
      }
      displayedCount = 10;
      renderActivity();
    });

    // Load more
    document.getElementById('load-more').addEventListener('click', () => {
      displayedCount += 10;
      renderActivity();
    });

    function renderActivity() {
      const filtered = allActivityData.filter(matchesFilters);
      const toShow = filtered.slice(0, displayedCount);

      let html = '';
      if (toShow.length === 0) {
        html = '<tr><td colspan="10" class="loading">No activity matching filters</td></tr>';
      } else {
        toShow.forEach(item => {
          const isApi = item.type === 'api_call';
          const isMessage = item.type === 'message';
          const from = isMessage ? truncate(item.from_address, 25) : '';
          const to = isMessage ? truncate(item.to_address, 25) : '';
          const model = isApi ? (item.model || '') : '';
          const tokens = isApi ? (item.tokens || 0) : '';
          const cost = isApi ? '$' + (item.cost_usd || 0).toFixed(4) : '';
          const subject = isMessage ? truncate(item.subject, 30, true) : '';
          const task = isApi ? truncate(item.description, 50) : '';

          html += `
            <tr>
              <td class="col-time">${formatDateTime(item.created_at)}</td>
              <td class="col-type"><span class="activity-type ${getActivityTypeClass(item)}">${getActivityTypeLabel(item)}</span></td>
              <td class="col-agent">${item.agent_name}</td>
              <td class="col-from">${from}</td>
              <td class="col-to">${to}</td>
              <td class="col-model">${model}</td>
              <td class="col-tokens">${tokens}</td>
              <td class="col-cost">${cost}</td>
              <td class="col-subject">${subject}</td>
              <td>${task}</td>
            </tr>
          `;
        });
      }
      document.getElementById('activity-body').innerHTML = html;
      document.getElementById('load-more').style.display = filtered.length > displayedCount ? 'block' : 'none';
    }

    function openModal(item) {
      document.getElementById('modal-title').innerHTML =
        (item.item_number ? '#' + item.item_number + ' ' : '') + item.title;

      const priorityClass = item.priority || 'medium';
      const categoryLabels = { token_optimization: 'Token Optimization', reliability: 'Reliability', features: 'Features' };
      const statusLabels = { pending: 'Pending', in_progress: 'In Progress', blocked: 'Blocked', completed: 'Completed' };

      let html = `
        <div class="modal-field">
          <div class="modal-label">Priority</div>
          <div class="modal-value"><span class="modal-priority ${priorityClass}">${item.priority || 'medium'}</span></div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Status</div>
          <div class="modal-value">${statusLabels[item.status] || item.status}</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Category</div>
          <div class="modal-value">${categoryLabels[item.category] || item.category}</div>
        </div>
        <div class="modal-field">
          <div class="modal-label">Description</div>
          <div class="modal-value">${item.description || '-'}</div>
        </div>
      `;
      if (item.impact_description) {
        html += `<div class="modal-field"><div class="modal-label">Impact</div><div class="modal-value">${item.impact_description}</div></div>`;
      }
      if (item.dependencies) {
        html += `<div class="modal-field"><div class="modal-label">Dependencies</div><div class="modal-value">${item.dependencies}</div></div>`;
      }
      if (item.assigned_to) {
        html += `<div class="modal-field"><div class="modal-label">Assigned To</div><div class="modal-value">${item.assigned_to}</div></div>`;
      }
      if (item.notes) {
        html += `<div class="modal-field"><div class="modal-label">Notes</div><div class="modal-value">${item.notes}</div></div>`;
      }

      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('backlog-modal').classList.add('open');
    }

    function closeModal() {
      document.getElementById('backlog-modal').classList.remove('open');
    }

    // Close modal on overlay click
    document.getElementById('backlog-modal').addEventListener('click', (e) => {
      if (e.target.id === 'backlog-modal') closeModal();
    });

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    function renderBacklog(backlog) {
      backlogData = backlog;
      const columns = { pending: [], in_progress: [], blocked: [], completed: [] };
      backlog.forEach(item => {
        if (columns[item.status]) columns[item.status].push(item);
      });

      const categoryLabels = { token_optimization: 'Tokens', reliability: 'Reliability', features: 'Features' };

      Object.keys(columns).forEach(status => {
        const col = document.getElementById('col-' + status);
        const headerEl = col.querySelector('.kanban-header');
        document.getElementById('count-' + status).textContent = `(${columns[status].length})`;

        let html = headerEl.outerHTML;
        columns[status].forEach((item, idx) => {
          html += `
            <div class="backlog-item priority-${item.priority}" onclick="openModal(backlogData.find(b => b.id === '${item.id}'))">
              <div class="backlog-title">${item.item_number ? '#' + item.item_number + ' ' : ''}${item.title}</div>
              <div class="backlog-meta">
                <span class="backlog-category">${categoryLabels[item.category] || item.category}</span>
                ${item.impact_description ? ' - ' + truncate(item.impact_description, 30) : ''}
              </div>
            </div>
          `;
        });
        col.innerHTML = html;
      });
    }

    async function loadData() {
      try {
        if (!authHeader) {
          showLogin();
          return;
        }

        const res = await fetch('/api/data', { headers: { 'Authorization': authHeader } });

        if (res.status === 401) {
          localStorage.removeItem('evryn_auth');
          authHeader = null;
          showLogin(true);
          return;
        }

        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();

        document.getElementById('timestamp').textContent = `${data.today} | Refreshed ${new Date().toLocaleTimeString()}`;

        // Build agent grid
        let agentHtml = '';
        agents.forEach(agent => {
          const agentKey = agent.toLowerCase();
          const status = data.agentStatus?.[agentKey] || { todaySpend: 0, halted: false, lastActivity: null };
          const spend = status.todaySpend || 0;
          const cls = getSpendClass(spend, data.alertThreshold, data.haltThreshold);
          const statusCls = getStatusClass(status);
          agentHtml += `
            <div class="agent-card ${cls} ${status.halted ? 'halted' : ''}">
              <div class="status-dot ${statusCls}" title="${statusCls}"></div>
              <div class="agent-name">${agent}</div>
              <div class="agent-spend ${cls}">$${spend.toFixed(3)}</div>
              <div class="agent-budget">/ $${data.budgetPerAgent.toFixed(2)}</div>
            </div>
          `;
        });
        document.getElementById('agent-grid').innerHTML = agentHtml;

        // Store all activity data and render
        allActivityData = data.activity || [];
        renderActivity();

        // Render month spend
        renderMonthSpend(data.monthSpend || { byAgent: {}, total: 0 });

        // Render backlog
        renderBacklog(data.backlog || []);

      } catch (err) {
        console.error(err);
        document.getElementById('agent-grid').innerHTML = '<div class="error">Failed to load data</div>';
      }
    }

    // Set up login handlers
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-btn').addEventListener('click', doLogin);
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('toggle-pw').addEventListener('click', () => {
        const input = document.getElementById('password-input');
        const btn = document.getElementById('toggle-pw');
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Hide';
        } else {
          input.type = 'password';
          btn.textContent = 'Show';
        }
      });
    });

    // Load on page load
    loadData();

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
  </script>
</body>
</html>
