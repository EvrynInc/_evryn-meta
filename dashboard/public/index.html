<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evryn Agents Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 16px 12px;
      line-height: 1.5;
      max-width: 100%;
    }
    h1 { color: #fff; margin-bottom: 8px; font-size: 1.4rem; }
    h2 { color: #888; margin: 20px 0 10px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; }
    .tab {
      padding: 8px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      color: #888;
      font-size: 0.85rem;
    }
    .tab.active { background: #222; color: #fff; border-bottom-color: #222; }
    .tab:hover:not(.active) { background: #222; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Agent Grid */
    .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 20px; }
    .agent-card {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 10px 12px;
      border: 1px solid #333;
      position: relative;
    }
    .agent-card.green { border-color: #22c55e; }
    .agent-card.yellow { border-color: #eab308; }
    .agent-card.red { border-color: #ef4444; }
    .agent-card.halted { opacity: 0.6; }
    .agent-name { font-size: 0.8rem; color: #fff; font-weight: 500; }
    .agent-spend { font-size: 1rem; font-weight: 600; margin-top: 2px; }
    .agent-spend.green { color: #22c55e; }
    .agent-spend.yellow { color: #eab308; }
    .agent-spend.red { color: #ef4444; }
    .agent-budget { font-size: 0.7rem; color: #666; }
    .status-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.active { background: #22c55e; }
    .status-dot.halted { background: #ef4444; }
    .status-dot.idle { background: #666; }

    /* Filters */
    .filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .filter-btn {
      padding: 4px 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      color: #888;
      font-size: 0.75rem;
    }
    .filter-btn.active { background: #333; color: #fff; border-color: #555; }
    .filter-btn:hover:not(.active) { background: #222; }

    /* Activity Feed */
    .activity-feed { margin-bottom: 24px; }
    .activity-item {
      display: grid;
      grid-template-columns: 100px 70px 1fr;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid #1a1a1a;
      font-size: 0.8rem;
      align-items: center;
    }
    .activity-item:hover { background: #1a1a1a; }
    .activity-time { color: #666; font-size: 0.75rem; }
    .activity-agent { color: #60a5fa; }
    .activity-desc { color: #888; }
    .activity-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      text-transform: uppercase;
      margin-right: 6px;
    }
    .type-api { background: #1e3a5f; color: #60a5fa; }
    .type-email-in { background: #14532d; color: #22c55e; }
    .type-email-out { background: #7c2d12; color: #f97316; }
    .type-inter { background: #4a1d6a; color: #a855f7; }

    .load-more {
      display: block;
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
    }
    .load-more:hover { background: #222; color: #fff; }

    /* Kanban */
    .kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; min-height: 400px; }
    @media (max-width: 900px) { .kanban { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .kanban { grid-template-columns: 1fr; } }
    .kanban-column {
      background: #111;
      border-radius: 6px;
      padding: 12px;
      min-height: 200px;
    }
    .kanban-header {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #222;
    }
    .kanban-header span { color: #888; font-size: 0.7rem; margin-left: 4px; }
    .backlog-item {
      background: #1a1a1a;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid #333;
      cursor: default;
    }
    .backlog-item.priority-high { border-left-color: #ef4444; }
    .backlog-item.priority-medium { border-left-color: #eab308; }
    .backlog-item.priority-low { border-left-color: #22c55e; }
    .backlog-title { font-size: 0.8rem; color: #fff; margin-bottom: 4px; }
    .backlog-meta { font-size: 0.7rem; color: #666; }
    .backlog-category {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 2px;
      font-size: 0.6rem;
      text-transform: uppercase;
      background: #222;
      color: #888;
    }

    /* Misc */
    .truncate { cursor: help; }
    .loading { color: #666; padding: 40px; text-align: center; }
    .error { color: #ef4444; padding: 40px; text-align: center; }
    .refresh {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .refresh:hover { background: #444; }
    .timestamp { color: #666; font-size: 0.75rem; margin-bottom: 16px; }
  </style>
</head>
<body>
  <div id="login-overlay" style="display:none; position:fixed; inset:0; background:#0a0a0a; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:40px; border-radius:8px; border:1px solid #333; text-align:center;">
      <h2 style="color:#fff; margin-bottom:20px;">Evryn Dashboard</h2>
      <div style="position:relative; display:inline-block;">
        <input type="password" id="password-input" placeholder="Password" style="padding:10px; width:200px; border:1px solid #333; background:#0a0a0a; color:#fff; border-radius:4px; padding-right:35px;">
        <button type="button" id="toggle-pw" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#666; cursor:pointer; font-size:14px;">Show</button>
      </div>
      <br><br>
      <button id="login-btn" style="padding:10px 30px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;">Login</button>
      <div id="login-error" style="color:#ef4444; margin-top:10px; display:none;">Invalid password</div>
    </div>
  </div>

  <button class="refresh" onclick="loadData()">Refresh</button>
  <h1>Evryn Agents</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <h2>Agent Status</h2>
  <div class="agent-grid" id="agent-grid">
    <div class="loading">Loading...</div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="activity">Activity</div>
    <div class="tab" data-tab="backlog">Backlog</div>
  </div>

  <div id="activity-tab" class="tab-content active">
    <div class="filters" id="filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="api_call">API Calls</button>
      <button class="filter-btn" data-filter="message-in">Emails In</button>
      <button class="filter-btn" data-filter="message-out">Emails Out</button>
      <button class="filter-btn" data-filter="inter_agent">Inter-Agent</button>
    </div>
    <div class="activity-feed" id="activity-feed">
      <div class="loading">Loading...</div>
    </div>
    <button class="load-more" id="load-more" style="display:none;">Load More</button>
  </div>

  <div id="backlog-tab" class="tab-content">
    <div class="kanban" id="kanban">
      <div class="kanban-column" id="col-pending">
        <div class="kanban-header">Pending <span id="count-pending"></span></div>
      </div>
      <div class="kanban-column" id="col-in_progress">
        <div class="kanban-header">In Progress <span id="count-in_progress"></span></div>
      </div>
      <div class="kanban-column" id="col-blocked">
        <div class="kanban-header">Blocked <span id="count-blocked"></span></div>
      </div>
      <div class="kanban-column" id="col-completed">
        <div class="kanban-header">Completed <span id="count-completed"></span></div>
      </div>
    </div>
  </div>

  <script>
    const agents = ['thea', 'taylor', 'jordan', 'dana', 'dominic', 'nathan', 'lucas', 'alex'];
    let currentFilter = 'all';
    let activityData = [];
    let currentOffset = 0;
    const pageSize = 50;

    function formatTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      const now = new Date();
      const isToday = d.toDateString() === now.toDateString();
      if (isToday) return formatTime(isoString);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + formatTime(isoString);
    }

    function getSpendClass(spend, alert, halt) {
      if (spend >= halt) return 'red';
      if (spend >= alert) return 'yellow';
      return 'green';
    }

    function getStatusClass(status) {
      if (status.halted) return 'halted';
      if (!status.lastActivity) return 'idle';
      const lastTime = new Date(status.lastActivity).getTime();
      const fiveMinAgo = Date.now() - 5 * 60 * 1000;
      return lastTime > fiveMinAgo ? 'active' : 'idle';
    }

    function truncate(str, len) {
      if (!str) return '-';
      const escaped = str.replace(/"/g, '&quot;').replace(/</g, '&lt;');
      if (str.length > len) {
        return `<span class="truncate" title="${escaped}">${str.substring(0, len)}...</span>`;
      }
      return escaped;
    }

    function getActivityTypeClass(item) {
      if (item.type === 'api_call') return 'type-api';
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'type-inter';
        return item.direction === 'inbound' ? 'type-email-in' : 'type-email-out';
      }
      return '';
    }

    function getActivityTypeLabel(item) {
      if (item.type === 'api_call') return 'API';
      if (item.type === 'message') {
        if (item.message_type === 'inter_agent') return 'Inter';
        return item.direction === 'inbound' ? 'In' : 'Out';
      }
      return '';
    }

    function getActivityDescription(item) {
      if (item.type === 'api_call') {
        return `${item.model || '-'} | $${(item.cost_usd || 0).toFixed(4)} | ${truncate(item.description, 60)}`;
      }
      if (item.type === 'message') {
        const addr = item.direction === 'inbound' ? item.from_address : item.to_address;
        return `${truncate(addr, 20)} - ${truncate(item.subject, 40)}`;
      }
      return '-';
    }

    function matchesFilter(item, filter) {
      if (filter === 'all') return true;
      if (filter === 'api_call') return item.type === 'api_call';
      if (filter === 'message-in') return item.type === 'message' && item.direction === 'inbound' && item.message_type !== 'inter_agent';
      if (filter === 'message-out') return item.type === 'message' && item.direction === 'outbound' && item.message_type !== 'inter_agent';
      if (filter === 'inter_agent') return item.type === 'message' && item.message_type === 'inter_agent';
      return true;
    }

    let authHeader = localStorage.getItem('evryn_auth') || null;

    function showLogin(showError = false) {
      document.getElementById('login-overlay').style.display = 'flex';
      document.getElementById('login-error').style.display = showError ? 'block' : 'none';
      document.getElementById('password-input').focus();
    }

    function hideLogin() {
      document.getElementById('login-overlay').style.display = 'none';
    }

    function doLogin() {
      const pass = document.getElementById('password-input').value;
      if (pass) {
        authHeader = 'Basic ' + btoa('evryn:' + pass);
        localStorage.setItem('evryn_auth', authHeader);
        hideLogin();
        loadData();
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // Filter switching
    document.getElementById('filters').addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        renderActivity();
      }
    });

    function renderActivity() {
      const filtered = activityData.filter(item => matchesFilter(item, currentFilter));
      let html = '';
      filtered.slice(0, 50).forEach(item => {
        html += `
          <div class="activity-item">
            <div class="activity-time">${formatDate(item.created_at)}</div>
            <div class="activity-agent">${item.agent_name}</div>
            <div class="activity-desc">
              <span class="activity-type ${getActivityTypeClass(item)}">${getActivityTypeLabel(item)}</span>
              ${getActivityDescription(item)}
            </div>
          </div>
        `;
      });
      document.getElementById('activity-feed').innerHTML = html || '<div class="loading">No activity</div>';
    }

    function renderBacklog(backlog) {
      const columns = { pending: [], in_progress: [], blocked: [], completed: [] };
      backlog.forEach(item => {
        if (columns[item.status]) columns[item.status].push(item);
      });

      const categoryLabels = {
        token_optimization: 'Tokens',
        reliability: 'Reliability',
        features: 'Features'
      };

      Object.keys(columns).forEach(status => {
        const col = document.getElementById('col-' + status);
        const header = col.querySelector('.kanban-header');
        document.getElementById('count-' + status).textContent = `(${columns[status].length})`;

        let html = '';
        columns[status].forEach(item => {
          html += `
            <div class="backlog-item priority-${item.priority}">
              <div class="backlog-title">${item.item_number ? '#' + item.item_number + ' ' : ''}${item.title}</div>
              <div class="backlog-meta">
                <span class="backlog-category">${categoryLabels[item.category] || item.category}</span>
                ${item.impact_description ? ' - ' + truncate(item.impact_description, 30) : ''}
              </div>
            </div>
          `;
        });
        // Keep header, replace items
        col.innerHTML = header.outerHTML + html;
      });
    }

    async function loadData() {
      try {
        if (!authHeader) {
          showLogin();
          return;
        }

        const res = await fetch('/api/data', {
          headers: { 'Authorization': authHeader }
        });

        if (res.status === 401) {
          localStorage.removeItem('evryn_auth');
          authHeader = null;
          showLogin(true);
          return;
        }

        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();

        // Update timestamp
        document.getElementById('timestamp').textContent =
          `${data.today} | Refreshed ${new Date().toLocaleTimeString()}`;

        // Build agent grid
        let agentHtml = '';
        agents.forEach(agent => {
          const status = data.agentStatus?.[agent] || { todaySpend: 0, halted: false, lastActivity: null };
          const spend = status.todaySpend || 0;
          const cls = getSpendClass(spend, data.alertThreshold, data.haltThreshold);
          const statusCls = getStatusClass(status);
          agentHtml += `
            <div class="agent-card ${cls} ${status.halted ? 'halted' : ''}">
              <div class="status-dot ${statusCls}" title="${statusCls}"></div>
              <div class="agent-name">${agent}</div>
              <div class="agent-spend ${cls}">$${spend.toFixed(3)}</div>
              <div class="agent-budget">/ $${data.budgetPerAgent.toFixed(2)}</div>
            </div>
          `;
        });
        document.getElementById('agent-grid').innerHTML = agentHtml;

        // Store activity data and render
        activityData = data.activity || [];
        renderActivity();

        // Render backlog
        renderBacklog(data.backlog || []);

        // Show/hide load more based on pagination
        document.getElementById('load-more').style.display = data.pagination?.hasMore ? 'block' : 'none';

      } catch (err) {
        console.error(err);
        document.getElementById('agent-grid').innerHTML = '<div class="error">Failed to load data</div>';
      }
    }

    // Set up login handlers
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-btn').addEventListener('click', doLogin);
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('toggle-pw').addEventListener('click', () => {
        const input = document.getElementById('password-input');
        const btn = document.getElementById('toggle-pw');
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'Hide';
        } else {
          input.type = 'password';
          btn.textContent = 'Show';
        }
      });
    });

    // Load on page load
    loadData();

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
  </script>
</body>
</html>
# Dashboard trigger
